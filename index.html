<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–°–≤–æ—è –∏–≥—Ä–∞</title>

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #1a2b6f, #050a2a);
  color: #fff;
  font-family: Arial, sans-serif;
}

/* ===== TOP BAR ===== */
#topBar{
  display:flex;
  justify-content:center;
  gap:20px;
  padding:15px;
}
#topBar button{
  font-size:20px;
  padding:10px 25px;
  cursor:pointer;
  border-radius:10px;
  border:none;
  background:#2345a5;
  color:#fff;
}

.player input {
  display: block;
  margin: 0 auto 6px auto;

  width: 100%;
  max-width: 180px;

  background: transparent;
  border: none;
  border-bottom: 2px solid rgba(255,255,255,0.3);

  color: #fff;
  text-align: center;
  font-size: 20px;
  font-weight: bold;

  outline: none;
}
/* ===== BOARD ===== */
#board {
  display: grid;
  grid-template-columns: 240px repeat(5, 1fr);
  gap: 12px;
  padding: 20px;
}

.cell {
  background: linear-gradient(#2345a5, #13235c);
  border: 2px solid #0c1a4a;
  padding: 25px 10px;
  text-align: center;
  cursor: pointer;
  border-radius: 10px;
  font-size: 30px;
  font-weight: bold;
}

.cell.used { visibility:hidden; }

.theme {
  background: linear-gradient(#0e1a4f, #060d2d);
  font-size: 20px;
}

/* ===== PLAYERS ===== */
#players {
  display: flex;
  justify-content: space-around;
  padding: 15px;
}

.player {
  background: linear-gradient(#101f5c, #0b1540);
  padding: 10px 20px;
  border-radius: 14px;
  width:220px;
  text-align:center;
}

.score{ font-size:32px; margin:10px 0; }

.controls button{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  font-size:22px;
  cursor:pointer;
}
.ok{background:#22b455}
.bad{background:#cc3b3b}

/* ===== MODALS ===== */
.modal{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  background:radial-gradient(circle,#1b2f85,#050a2a);
  z-index:20;
}

.close{
  position:absolute;
  top:20px;
  right:30px;
  font-size:40px;
  cursor:pointer;
}

/* QUESTION */
#questionText{
  white-space: pre-line;
  font-size:clamp(24px,4vw,52px);
  text-align:center;
  max-width:80%;
  white-space:pre-line;
}

#answerText{
  white-space: pre-line;
  margin-top:20px;
  font-size:clamp(22px,4vw,50px);
  text-align:center;
  max-width:80%;
  display:none;
}

.media-images {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 25px;
  flex-wrap: wrap;
}

.media-image img {
  max-width: 800px;
  max-height: 800px;
  border-radius: 12px;
  background: linear-gradient(90deg, #13235c 0%, #2345a5 50%, #13235c 100%);
  background-size: 200% 100%;
}

.media-images img {
  max-width: 500px;
  max-height: 500px;
  border-radius: 12px;
  object-fit: contain;
}

/* –ê—É–¥–∏–æ –ø–ª–µ–µ—Ä */
.custom-audio-player {
  margin: 20px 0;
  display: flex;
  align-items: center;
  gap: 15px;
  background: rgba(0, 0, 0, 0.3);
  padding: 15px;
  border-radius: 10px;
}

.custom-audio-player button {
  background: #2345a5;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
}

.custom-audio-player button:hover {
  background: #2a52c5;
}

/* ===== CAT IN THE BAG ===== */
#catScreen{
  animation:flash 1.2s infinite alternate;
}
#catScreen h1{
  font-size:90px;
  animation:pulse 1s infinite;
}

@keyframes pulse{
  from{transform:scale(1)}
  to{transform:scale(1.15)}
}

@keyframes flash{
  from{background:#0a123a}
  to{background:#1e3cff}
}

/* Loading animation */
.loading {
  animation: loading 1.5s infinite;
}

@keyframes loading {
  0% { background-position: -200px 0; }
  100% { background-position: 200px 0; }
}
</style>
</head>

<body>

<div id="topBar">
  <button onclick="showSponsor()">–°–ø–æ–Ω—Å–æ—Ä</button>
  <button onclick="showIntro()">–ó–∞—Å—Ç–∞–≤–∫–∞</button>
</div>

<div id="board"></div>
<div id="players"></div>

<!-- QUESTION -->
<div id="questionModal" class="modal">
  <div class="close" onclick="closeQuestion()">‚úñ</div>
  <div id="questionText"></div>
  <div id="mediaBox"></div>
  <div id="answerText"></div>
  <button onclick="showAnswer()">–û—Ç–≤–µ—Ç</button>
</div>

<!-- CAT -->
<div id="catScreen" class="modal">
  <h1>üê± –ö–û–¢ –í –ú–ï–®–ö–ï</h1>
  <button onclick="continueCat()">–î–∞–ª–µ–µ</button>
</div>

<!-- SPONSOR -->
<div id="sponsorModal" class="modal">
  <div class="close" onclick="closeSponsor()">‚úñ</div>
  <img src="media/Sponsor.png" style="max-width:90%;max-height:90%">
</div>

<!-- INTRO -->
<div id="introModal" class="modal">
  <div class="close" onclick="closeIntro()">‚úñ</div>
  <img src="media/Intro.png" style="max-width:90%;margin-bottom:20px">
</div>

<script>
// ===== –ê–£–î–ò–û –ú–ï–ù–ï–î–ñ–ï–† =====
class AudioManager {
  constructor() {
    this.audioCache = new Map(); // –ö–µ—à –∞—É–¥–∏–æ –æ–±—ä–µ–∫—Ç–æ–≤
    this.audioPromises = new Map(); // –ü—Ä–æ–º–∏—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏
    this.preloadedAudios = new Set(); // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∞—É–¥–∏–æ
    this.activeAudio = null;
  }

  // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ
  async loadAudio(src) {
    // –ï—Å–ª–∏ —É–∂–µ –≤ –∫–µ—à–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
    if (this.audioCache.has(src)) {
      return this.audioCache.get(src);
    }

    // –ï—Å–ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ–º–∏—Å
    if (this.audioPromises.has(src)) {
      return this.audioPromises.get(src);
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–º–∏—Å –∑–∞–≥—Ä—É–∑–∫–∏
    const loadPromise = new Promise((resolve, reject) => {
      const audio = new Audio();
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º preload –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
      audio.preload = 'metadata';
      
      audio.addEventListener('canplaythrough', () => {
        this.audioCache.set(src, audio);
        this.audioPromises.delete(src);
        resolve(audio);
      }, { once: true });
      
      audio.addEventListener('error', (e) => {
        this.audioPromises.delete(src);
        reject(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ: ${src}`));
      }, { once: true });
      
      audio.src = src;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
      audio.load();
    });

    this.audioPromises.set(src, loadPromise);
    return loadPromise;
  }

  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∞—É–¥–∏–æ
  preloadCriticalAudios() {
    const criticalAudios = [
      'media/cat.mp3',
      'media/intro.mp3'
    ];
    
    criticalAudios.forEach(src => {
      if (!this.preloadedAudios.has(src)) {
        this.loadAudio(src).then(() => {
          this.preloadedAudios.add(src);
        }).catch(console.error);
      }
    });
  }

  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ
  async playAudio(src, autoplay = true) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∞—É–¥–∏–æ
    if (this.activeAudio) {
      this.activeAudio.pause();
      this.activeAudio.currentTime = 0;
    }

    try {
      const audio = await this.loadAudio(src);
      this.activeAudio = audio;
      
      if (autoplay) {
        await audio.play();
      }
      
      return audio;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', error);
      return null;
    }
  }

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞—É–¥–∏–æ
  stopAudio() {
    if (this.activeAudio) {
      this.activeAudio.pause();
      this.activeAudio.currentTime = 0;
      this.activeAudio = null;
    }
  }

  // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤
  cleanup() {
    this.stopAudio();
    // –û—á–∏—â–∞–µ–º –∫–µ—à –æ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∞—É–¥–∏–æ
    this.audioCache.forEach((audio, src) => {
      if (!this.preloadedAudios.has(src)) {
        audio.pause();
        audio.src = '';
        this.audioCache.delete(src);
      }
    });
  }
}

// ===== –ú–ï–ù–ï–î–ñ–ï–† –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô =====
class ImageManager {
  constructor() {
    this.imageCache = new Map();
    this.intersectionObserver = null;
    this.initObserver();
  }

  initObserver() {
    this.intersectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          const src = img.dataset.src;
          
          if (src && !img.src.includes(src)) {
            this.loadImageWithCache(src).then(url => {
              img.src = url;
              img.classList.remove('loading');
            });
          }
          
          this.intersectionObserver.unobserve(img);
        }
      });
    }, {
      rootMargin: '100px',
      threshold: 0.1
    });
  }

  async loadImageWithCache(src) {
    if (this.imageCache.has(src)) {
      return this.imageCache.get(src);
    }

    return new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => {
        this.imageCache.set(src, src);
        resolve(src);
      };
      img.onerror = reject;
      img.src = src;
    });
  }

  preloadImages(urls) {
    urls.forEach(url => {
      if (!this.imageCache.has(url)) {
        const img = new Image();
        img.onload = () => this.imageCache.set(url, url);
        img.src = url;
      }
    });
  }

  observeImage(img) {
    if (this.intersectionObserver && img.dataset.src) {
      this.intersectionObserver.observe(img);
    } else if (img.src) {
      this.loadImageWithCache(img.src);
    }
  }
}

// ===== –û–°–ù–û–í–ù–û–ô –ö–û–î =====
const audioManager = new AudioManager();
const imageManager = new ImageManager();

let data;
let scores = [0, 0, 0, 0];
let pendingQuestion = null;
let currentPrice = 0;
let playerNames = ["–ò–≥—Ä–æ–∫ 1", "–ò–≥—Ä–æ–∫ 2", "–ò–≥—Ä–æ–∫ 3", "–ò–≥—Ä–æ–∫ 4"];
let introAudioPromise = null;

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
fetch('./questions.json').then(r => r.json()).then(j => {
  data = j;
  renderBoard();
  renderPlayers();
  
  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ–¥–∏–∞
  preloadCriticalMedia();
  audioManager.preloadCriticalAudios();
});

function preloadCriticalMedia() {
  const mediaToPreload = {
    images: new Set(),
    audios: new Set()
  };
  
  // –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ (–ø–µ—Ä–≤—ã–µ 2 –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ –∫–∞–∂–¥–æ–π —Ç–µ–º—ã)
  data.themes.forEach(theme => {
    theme.questions.slice(0, 2).forEach(q => {
      if (q.media) {
        if (q.media.type === 'image') {
          mediaToPreload.images.add(q.media.src);
        } else if (q.media.type === 'images') {
          q.media.src.slice(0, 2).forEach(src => mediaToPreload.images.add(src));
        } else if (q.media.type === 'audio') {
          mediaToPreload.audios.add(q.media.src);
        }
      }
    });
  });
  
  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  imageManager.preloadImages(Array.from(mediaToPreload.images));
  
  // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ (–ª–µ–Ω–∏–≤–æ, —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
  mediaToPreload.audios.forEach(src => {
    audioManager.loadAudio(src).catch(() => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
    });
  });
}

function renderBoard() {
  const b = document.getElementById('board');
  b.innerHTML = '';

  data.themes.forEach((theme, themeIndex) => {
    // === –Ø–ß–ï–ô–ö–ê –¢–ï–ú–´ ===
    const themeCell = document.createElement('div');
    themeCell.className = 'cell theme';
    themeCell.textContent = theme.title;
    b.appendChild(themeCell);

    // === –í–û–ü–†–û–°–´ ===
    theme.questions.forEach((q, questionIndex) => {
      const c = document.createElement('div');
      c.className = 'cell';
      c.textContent = q.price;
      c.dataset.themeIndex = themeIndex;
      c.dataset.questionIndex = questionIndex;

      c.onclick = () => {
        if (c.classList.contains('used')) return;
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ
        lazyPreloadNeighbors(themeIndex, questionIndex);
        
        selectQuestion(c, q);
      };

      b.appendChild(c);
    });
  });
}

function lazyPreloadNeighbors(themeIndex, questionIndex) {
  const neighbors = [];
  
  // –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞ —Å–æ—Å–µ–¥–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
  for (let t = Math.max(0, themeIndex - 1); t <= Math.min(data.themes.length - 1, themeIndex + 1); t++) {
    for (let q = Math.max(0, questionIndex - 1); q <= Math.min(data.themes[t].questions.length - 1, questionIndex + 1); q++) {
      const question = data.themes[t].questions[q];
      if (question.media && !question._preloaded) {
        neighbors.push(question);
        question._preloaded = true;
      }
    }
  }
  
  // –õ–µ–Ω–∏–≤–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞
  neighbors.forEach(question => {
    if (question.media.type === 'image') {
      imageManager.loadImageWithCache(question.media.src).catch(() => {});
    } else if (question.media.type === 'images') {
      question.media.src.slice(0, 2).forEach(src => {
        imageManager.loadImageWithCache(src).catch(() => {});
      });
    } else if (question.media.type === 'audio') {
      audioManager.loadAudio(question.media.src).catch(() => {});
    }
  });
}

function renderPlayers() {
  const p = document.getElementById('players');
  p.innerHTML = '';

  scores.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'player';

    div.innerHTML = `
      <input value="${playerNames[i]}" data-index="${i}">
      <div class="score">${s}</div>
      <div class="controls">
        <button class="ok">‚úî</button>
        <button class="bad">‚úñ</button>
      </div>
    `;

    div.querySelector('.ok').onclick = () => {
      scores[i] += currentPrice;
      renderPlayers();
    };

    div.querySelector('.bad').onclick = () => {
      scores[i] -= currentPrice;
      renderPlayers();
    };

    const input = div.querySelector('input');
    input.oninput = (e) => {
      playerNames[i] = e.target.value;
    };

    p.appendChild(div);
  });
}

function selectQuestion(cell, q) {
  cell.classList.add('used');
  currentPrice = q.price;

  if (Math.random() < 0.15) {
    pendingQuestion = q;
    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º cat.mp3 —á–µ—Ä–µ–∑ –∞—É–¥–∏–æ –º–µ–Ω–µ–¥–∂–µ—Ä
    audioManager.playAudio('media/cat.mp3').then(() => {
      document.getElementById('catScreen').style.display = 'flex';
    });
  } else {
    openQuestion(q);
  }
}

function continueCat() {
  audioManager.stopAudio();
  document.getElementById('catScreen').style.display = 'none';
  
  if (pendingQuestion) {
    openQuestion(pendingQuestion);
    pendingQuestion = null;
  }
}

async function openQuestion(q) {
  document.getElementById('questionText').textContent = q.question;
  document.getElementById('answerText').textContent = q.answer;
  document.getElementById('answerText').style.display = 'none';

  const mediaBox = document.getElementById('mediaBox');
  mediaBox.innerHTML = '';

  if (q.media) {
    if (q.media.type === 'image') {
      mediaBox.innerHTML = `
        <div class="media-image">
          <img data-src="${q.media.src}" 
               src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600' viewBox='0 0 800 600'%3E%3Crect width='800' height='600' fill='%2313235c'/%3E%3C/svg%3E"
               class="loading">
        </div>`;
      
      const img = mediaBox.querySelector('img');
      imageManager.observeImage(img);
    } else if (q.media.type === 'images') {
      const imagesHTML = q.media.src.map(src => `
        <img data-src="${src}"
             src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Crect width='500' height='500' fill='%2313235c'/%3E%3C/svg%3E"
             class="loading">
      `).join('');
      
      mediaBox.innerHTML = `<div class="media-images">${imagesHTML}</div>`;
      
      // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      mediaBox.querySelectorAll('img').forEach(img => {
        imageManager.observeImage(img);
      });
    } else if (q.media.type === 'audio') {
      mediaBox.innerHTML = `
        <div class="custom-audio-player">
          <button onclick="playQuestionAudio()">‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
          <button onclick="pauseQuestionAudio()">‚è∏ –ü–∞—É–∑–∞</button>
        </div>`;
      
      // –õ–µ–Ω–∏–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –∞—É–¥–∏–æ
      window.currentQuestionAudio = q.media.src;
    }
  }

  document.getElementById('questionModal').style.display = 'flex';
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—É–¥–∏–æ –≤–æ–ø—Ä–æ—Å–∞
async function playQuestionAudio() {
  if (window.currentQuestionAudio) {
    const audio = await audioManager.playAudio(window.currentQuestionAudio, false);
    if (audio) {
      audio.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
    }
  }
}

function pauseQuestionAudio() {
  audioManager.stopAudio();
}

function showAnswer() {
  document.getElementById('answerText').style.display = 'block';
  // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –æ—Ç–≤–µ—Ç–∞
  audioManager.stopAudio();
}

function closeQuestion() {
  audioManager.stopAudio();
  document.getElementById('questionModal').style.display = 'none';
  window.currentQuestionAudio = null;
}

/* SPONSOR */
function showSponsor() {
  document.getElementById('sponsorModal').style.display = 'flex';
}

function closeSponsor() {
  document.getElementById('sponsorModal').style.display = 'none';
}

/* INTRO */
async function showIntro() {
  document.getElementById('introModal').style.display = 'flex';
  
  // –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ intro.mp3
  try {
    await audioManager.playAudio('media/intro.mp3');
  } catch (error) {
    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∏–Ω—Ç—Ä–æ:', error);
  }
}

function closeIntro() {
  audioManager.stopAudio();
  document.getElementById('introModal').style.display = 'none';
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
  audioManager.cleanup();
});

// –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
document.addEventListener('click', () => {
  audioManager.preloadCriticalAudios();
}, { once: true });
</script>

</body>
</html>